/**
 * AWS Lambda Function: Student Profiles DynamoDB Handler
 * 
 * This Lambda function handles DynamoDB operations for Student Profiles via API Gateway.
 * It uses the Lambda execution role (auto-generated by AWS Academy) to access DynamoDB.
 * 
 * Deployment:
 * 1. Copy this file to Lambda console as index.js (or update handler name)
 * 2. Set handler to: index.handler
 * 3. Set runtime to: Node.js 18.x or later
 * 4. Configure environment variable: STUDENT_PROFILES_TABLE_NAME
 * 5. Attach IAM policy to execution role: dynamodb:GetItem, dynamodb:PutItem, dynamodb:UpdateItem, dynamodb:DeleteItem
 * 6. Set timeout to 30 seconds
 * 7. Set memory to 256 MB
 * 
 * Note: AWS SDK v2 is built into Lambda runtime, no need to install
 */

const AWS = require('aws-sdk');
const dynamodb = new AWS.DynamoDB.DocumentClient();

/**
 * Lambda handler function
 * @param {Object} event - API Gateway event
 * @param {Object} context - Lambda context
 * @returns {Object} API Gateway response
 */
exports.handler = async (event) => {
  console.log('Received Student Profiles DynamoDB request:', JSON.stringify(event, null, 2));
  
  try {
    // Get table name from environment variable
    const tableName = process.env.STUDENT_PROFILES_TABLE_NAME || 'student_profiles';
    
    // Parse request body
    let body;
    try {
      body = typeof event.body === 'string' ? JSON.parse(event.body) : event.body;
    } catch (parseError) {
      throw new Error('Invalid JSON in request body');
    }
    
    // Get operation
    const operation = body.operation || 'getStudentProfile';
    
    let result;
    
    switch (operation) {
      case 'getStudentProfile':
        // Get student profile by studentId
        if (!body.studentId) {
          throw new Error('studentId is required for getStudentProfile operation');
        }
        
        result = await dynamodb.get({
          TableName: tableName,
          Key: { studentId: body.studentId }
        }).promise();
        
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
          body: JSON.stringify({
            success: true,
            data: result.Item || null,
          }),
        };
        
      case 'putStudentProfile':
        // Create or update student profile
        if (!body.studentId) {
          throw new Error('studentId is required for putStudentProfile operation');
        }
        
        if (!body.profileData) {
          throw new Error('profileData is required for putStudentProfile operation');
        }
        
        const now = new Date().toISOString();
        
        // Check if profile exists
        const existingProfile = await dynamodb.get({
          TableName: tableName,
          Key: { studentId: body.studentId }
        }).promise();
        
        const profileData = {
          studentId: body.studentId,
          skills: body.profileData.skills || [],
          aspirations: body.profileData.aspirations || null,
          parsed_resume: body.profileData.parsed_resume || null,
          projects: body.profileData.projects || [],
          experiences: body.profileData.experiences || [],
          achievements: body.profileData.achievements || [],
          resume_url: body.profileData.resume_url || null,
          updatedAt: now,
        };
        
        // If profile exists, preserve createdAt; otherwise set it
        if (existingProfile.Item && existingProfile.Item.createdAt) {
          profileData.createdAt = existingProfile.Item.createdAt;
        } else {
          profileData.createdAt = now;
        }
        
        await dynamodb.put({
          TableName: tableName,
          Item: profileData,
        }).promise();
        
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
          body: JSON.stringify({
            success: true,
            data: profileData,
          }),
        };
        
      case 'updateStudentProfile':
        // Update specific fields in student profile
        if (!body.studentId) {
          throw new Error('studentId is required for updateStudentProfile operation');
        }
        
        // Check if profile exists
        const profileToUpdate = await dynamodb.get({
          TableName: tableName,
          Key: { studentId: body.studentId }
        }).promise();
        
        if (!profileToUpdate.Item) {
          return {
            statusCode: 404,
            headers: {
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
              success: false,
              error: 'Student profile not found',
            }),
          };
        }
        
        // Build update expression
        const updateExpressions = [];
        const expressionAttributeNames = {};
        const expressionAttributeValues = {};
        
        const updateFields = ['skills', 'aspirations', 'parsed_resume', 'projects', 'experiences', 'achievements', 'resume_url'];
        updateFields.forEach((field, index) => {
          if (body.profileData && body.profileData[field] !== undefined) {
            const nameKey = `#attr${index}`;
            const valueKey = `:val${index}`;
            updateExpressions.push(`${nameKey} = ${valueKey}`);
            expressionAttributeNames[nameKey] = field;
            expressionAttributeValues[valueKey] = body.profileData[field];
          }
        });
        
        // Always update updatedAt
        const updatedAtKey = `#attr${updateExpressions.length}`;
        const updatedAtValue = `:val${updateExpressions.length}`;
        updateExpressions.push(`${updatedAtKey} = ${updatedAtValue}`);
        expressionAttributeNames[updatedAtKey] = 'updatedAt';
        expressionAttributeValues[updatedAtValue] = new Date().toISOString();
        
        if (updateExpressions.length === 0) {
          throw new Error('No fields to update');
        }
        
        const updateResult = await dynamodb.update({
          TableName: tableName,
          Key: { studentId: body.studentId },
          UpdateExpression: `SET ${updateExpressions.join(', ')}`,
          ExpressionAttributeNames: expressionAttributeNames,
          ExpressionAttributeValues: expressionAttributeValues,
          ReturnValues: 'ALL_NEW',
        }).promise();
        
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
          body: JSON.stringify({
            success: true,
            data: updateResult.Attributes,
          }),
        };
        
      case 'deleteStudentProfile':
        // Delete student profile
        if (!body.studentId) {
          throw new Error('studentId is required for deleteStudentProfile operation');
        }
        
        // Check if profile exists
        const profileToDelete = await dynamodb.get({
          TableName: tableName,
          Key: { studentId: body.studentId }
        }).promise();
        
        if (!profileToDelete.Item) {
          return {
            statusCode: 404,
            headers: {
              'Content-Type': 'application/json',
              'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
              success: false,
              error: 'Student profile not found',
            }),
          };
        }
        
        await dynamodb.delete({
          TableName: tableName,
          Key: { studentId: body.studentId }
        }).promise();
        
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*',
          },
          body: JSON.stringify({
            success: true,
            message: 'Student profile deleted successfully',
          }),
        };
        
      default:
        throw new Error(`Unsupported operation: ${operation}`);
    }
    
  } catch (error) {
    console.error('Student Profiles DynamoDB operation error:', error);
    
    return {
      statusCode: error.statusCode || 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        success: false,
        error: error.message || 'Failed to process DynamoDB operation',
      }),
    };
  }
};

