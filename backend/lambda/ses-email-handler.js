/**
 * AWS Lambda Function: SES Email Handler
 * 
 * This Lambda function sends emails via AWS SES through API Gateway.
 * It uses the Lambda execution role (auto-generated by AWS Academy) to access SES.
 * 
 * Deployment:
 * 1. Copy this file to Lambda console as index.js (or update handler name)
 * 2. Set handler to: index.handler
 * 3. Set runtime to: Node.js 18.x or later
 * 4. Configure environment variables: ADMIN_EMAIL, FROM_EMAIL
 * 5. Attach IAM policy to execution role: ses:SendEmail
 * 6. Set timeout to 30 seconds
 * 7. Set memory to 256 MB
 * 
 * Note: AWS SDK v2 is built into Lambda runtime, no need to install
 */

const AWS = require('aws-sdk');
const ses = new AWS.SES();

/**
 * Lambda handler function
 * @param {Object} event - API Gateway event
 * @param {Object} context - Lambda context
 * @returns {Object} API Gateway response
 */
exports.handler = async (event) => {
  console.log('Received email request:', JSON.stringify(event, null, 2));
  
  try {
    // Get environment variables
    const adminEmail = process.env.ADMIN_EMAIL;
    const fromEmail = process.env.FROM_EMAIL;
    
    if (!adminEmail || !fromEmail) {
      throw new Error('ADMIN_EMAIL and FROM_EMAIL environment variables must be set');
    }
    
    // Parse request body
    let body;
    try {
      body = typeof event.body === 'string' ? JSON.parse(event.body) : event.body;
    } catch (parseError) {
      throw new Error('Invalid JSON in request body');
    }
    
    // Extract email parameters
    const {
      alumniEmail,
      alumniName = 'Alumni',
      eventId,
      eventTitle,
      preferredDateTime,
      preferredLocation,
    } = body;
    
    // Validate required fields
    if (!alumniEmail || !eventId || !eventTitle || !preferredDateTime || !preferredLocation) {
      throw new Error('Missing required fields: alumniEmail, eventId, eventTitle, preferredDateTime, preferredLocation');
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(alumniEmail)) {
      throw new Error('Invalid alumni email format');
    }
    
    // Prepare email content
    const subject = `New Judge Interest: ${eventTitle}`;
    
    const emailBody = `
      <html>
        <body>
          <h2>New Judge Interest Notification</h2>
          <p>An alumni has expressed interest in participating as a judge for an event.</p>
          
          <h3>Event Details:</h3>
          <ul>
            <li><strong>Event ID:</strong> ${eventId}</li>
            <li><strong>Event Title:</strong> ${eventTitle}</li>
          </ul>
          
          <h3>Alumni Details:</h3>
          <ul>
            <li><strong>Name:</strong> ${alumniName}</li>
            <li><strong>Email:</strong> ${alumniEmail}</li>
          </ul>
          
          <h3>Preferences:</h3>
          <ul>
            <li><strong>Preferred Date/Time:</strong> ${preferredDateTime}</li>
            <li><strong>Preferred Location:</strong> ${preferredLocation}</li>
          </ul>
          
          <p>Please review and contact the alumni to confirm their participation.</p>
        </body>
      </html>
    `;
    
    const textBody = `
New Judge Interest Notification

An alumni has expressed interest in participating as a judge for an event.

Event Details:
- Event ID: ${eventId}
- Event Title: ${eventTitle}

Alumni Details:
- Name: ${alumniName}
- Email: ${alumniEmail}

Preferences:
- Preferred Date/Time: ${preferredDateTime}
- Preferred Location: ${preferredLocation}

Please review and contact the alumni to confirm their participation.
    `;
    
    // Send email via SES
    const emailParams = {
      Source: fromEmail,
      Destination: {
        ToAddresses: [adminEmail],
      },
      Message: {
        Subject: {
          Data: subject,
          Charset: 'UTF-8',
        },
        Body: {
          Html: {
            Data: emailBody,
            Charset: 'UTF-8',
          },
          Text: {
            Data: textBody,
            Charset: 'UTF-8',
          },
        },
      },
      ReplyToAddresses: [alumniEmail],
    };
    
    const result = await ses.sendEmail(emailParams).promise();
    
    console.log('Email sent successfully:', result.MessageId);
    
    return {
      statusCode: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        success: true,
        messageId: result.MessageId,
        message: 'Email sent successfully',
      }),
    };
    
  } catch (error) {
    console.error('Email sending error:', error);
    
    // Provide helpful error messages
    let errorMessage = error.message || 'Failed to send email';
    let statusCode = 500;
    
    if (error.code === 'MessageRejected') {
      errorMessage = 'Email was rejected. Please verify the email addresses in your SES configuration.';
      statusCode = 400;
    } else if (error.code === 'MailFromDomainNotVerifiedException') {
      errorMessage = 'FROM_EMAIL domain is not verified in SES. Please verify your domain or use a verified email address.';
      statusCode = 400;
    } else if (error.code === 'ConfigurationSetDoesNotExistException') {
      errorMessage = 'SES configuration set does not exist. Please check your SES configuration.';
      statusCode = 400;
    }
    
    return {
      statusCode: statusCode,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
      },
      body: JSON.stringify({
        success: false,
        error: errorMessage,
      }),
    };
  }
};

